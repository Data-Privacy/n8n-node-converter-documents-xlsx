# n8n-node-converter-documents

## Описание

Этот проект представляет собой кастомный нод для n8n, предназначенный для конвертации различных файловых форматов в JSON или текстовый вид. Поддерживаются следующие форматы: DOC, DOCX, XML, XLS, XLSX, CSV, PDF, TXT, PPT, PPTX, HTML/HTM.

## Важно: ограничения по большим файлам

- **PDF, XLS, XLSX:** используемые библиотеки (`pdf-parse`, `xlsx`) загружают весь файл в память. При обработке очень больших файлов (десятки мегабайт, сотни тысяч строк) возможны сбои, зависания и превышение лимита памяти. Для таких случаев рекомендуется предварительно разбивать файлы или использовать специализированные инструменты.
- **CSV, TXT:** реализована потоковая обработка для больших файлов (через papaparse и readline).

## Безопасность и валидация

- Входные данные проходят строгую валидацию (тип, структура, размер, наличие бинарных данных).
- Для HTML/HTM используется sanitize-html для защиты от XSS и вредоносных скриптов.

## Возможности

- Автоматическое определение типа файла по расширению или содержимому
- Извлечение текста или таблиц из популярных офисных и текстовых форматов
- Выходные данные: `{ text: "..." }` или `{ sheets: {...} }` + метаданные (имя, размер, тип файла, время обработки)
- Обработка больших файлов (до 50 МБ для большинства форматов)
- Сообщения о пустых или неподдерживаемых файлах
- Защита от вредоносных данных и XSS

## Используемые библиотеки

- **xml2js** — для разбора XML
- **mammoth** — для извлечения текста из DOCX
- **textract** — для DOC, PPT, PPTX
- **xlsx** — для XLS, XLSX, CSV
- **pdf-parse** — для PDF
- **cheerio** — для HTML/HTM
- **sanitize-html** — для очистки HTML/HTM
- **file-type** — для определения типа файла по содержимому
- **chardet** + **iconv-lite** — для определения и декодирования кодировки TXT

## Примеры входных и выходных данных

**Вход:**

- Бинарный файл (например, DOCX, PDF, XLSX и др.) в поле `data`.

**Выход:**

- Для текстовых форматов:

```json
{
  "text": "Извлечённый текст...",
  "metadata": {
    "fileName": "example.docx",
    "fileSize": 12345,
    "fileType": "docx",
    "processedAt": "2024-06-01T12:00:00.000Z"
  }
}
```

- Для табличных форматов:

```json
{
  "sheets": {
    "Sheet1": [ { "A": "Значение1", "B": "Значение2" }, ... ]
  },
  "metadata": {
    "fileName": "example.xlsx",
    "fileSize": 23456,
    "fileType": "xlsx",
    "processedAt": "2024-06-01T12:00:00.000Z"
  }
}
```

## Структура проекта

- `src/` — папка для исходного кода (основная логика)
- `helpers.ts` — вспомогательные функции
- `errors.ts` — кастомные классы ошибок
- `test/` — папка для тестовых файлов и юнит-тестов
- `package.json` — файл зависимостей и скриптов
- `.gitignore` — исключает node_modules, dist и временные файлы из git

## Установка зависимостей

Все необходимые зависимости устанавливаются через npm:

```
npm install
```

## Рекомендации

- Для добавления новых форматов потребуется добавить соответствующую библиотеку и обработчик в основной файл.
- Для интеграции в n8n убедитесь, что нод корректно подключён к вашей системе.
- Для работы с очень большими PDF, XLS, XLSX используйте предварительную обработку или сторонние инструменты.
- Для безопасности всегда обновляйте зависимости и следите за актуальностью sanitize-html.

## Сборка и использование с TypeScript

1. Для сборки проекта выполните:
   ```
   npm run build
   ```
   Итоговые файлы появятся в папке `dist/`.
2. Для использования кастомного нода в n8n укажите путь к `dist/FileToJsonNode.node.js`.
3. Основной файл для n8n теперь: `dist/FileToJsonNode.node.js` (см. поле `main` в package.json).

---

Если потребуется документация по какому-либо модулю или помощь с интеграцией — обращайтесь!
