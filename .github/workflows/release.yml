name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  actions: read

jobs:
  # –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
  test:
    name: Run Tests Before Release
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ù—É–∂–Ω–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ changelog
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install Dependencies
      run: npm ci
      
    - name: Build Project
      run: npm run build
      
    - name: Verify Build Artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "‚ùå Build artifacts not found!"
          exit 1
        fi
        
        if [ ! -f "dist/FileToJsonNode.node.js" ]; then
          echo "‚ùå Main build file not found!"
          exit 1
        fi
        
        echo "‚úÖ Build artifacts verified"
        ls -la dist/
        
    - name: Get Version from Tag
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG=${GITHUB_REF#refs/tags/}
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=${TAG#v}" >> $GITHUB_OUTPUT
        echo "Release version: $TAG"
        
    - name: Update Package Version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        TARGET_VERSION="${{ steps.version.outputs.version }}"
        
        if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
          npm version $TARGET_VERSION --no-git-tag-version
          echo "‚úÖ Package version updated from $CURRENT_VERSION to $TARGET_VERSION"
        else
          echo "‚úÖ Package version is already $TARGET_VERSION - no update needed"
        fi
        
    - name: Generate Changelog
      id: changelog
      run: |
        echo "# üöÄ Release ${{ steps.version.outputs.tag }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## üìã Changes in this release:" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ–≥–∞ (—Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ] && [ "$LAST_TAG" != "${{ steps.version.outputs.tag }}" ]; then
          echo "### üìù Commits since $LAST_TAG:" >> CHANGELOG.md
          COMMIT_COUNT=$(git rev-list $LAST_TAG..HEAD --count 2>/dev/null || echo "0")
          if [ "$COMMIT_COUNT" -gt "0" ]; then
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges >> CHANGELOG.md
          else
            echo "- No new commits since last tag" >> CHANGELOG.md
          fi
        else
          echo "### üìù All commits:" >> CHANGELOG.md
          TOTAL_COMMITS=$(git rev-list HEAD --count 2>/dev/null || echo "0")
          if [ "$TOTAL_COMMITS" -gt "0" ]; then
            git log --pretty=format:"- %s (%h)" --no-merges --max-count=20 >> CHANGELOG.md
            if [ "$TOTAL_COMMITS" -gt "20" ]; then
              echo "" >> CHANGELOG.md
              echo "- ... and $(($TOTAL_COMMITS - 20)) more commits" >> CHANGELOG.md
            fi
          else
            echo "- Initial release" >> CHANGELOG.md
          fi
        fi
        
        echo "" >> CHANGELOG.md
        echo "## üèóÔ∏è Build Information:" >> CHANGELOG.md
        echo "- **Built on:** $(date)" >> CHANGELOG.md
        echo "- **Node.js version:** $(node --version)" >> CHANGELOG.md
        echo "- **npm version:** $(npm --version)" >> CHANGELOG.md
        echo "- **Git commit:** $(git rev-parse HEAD)" >> CHANGELOG.md
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º changelog
        echo "Generated changelog:"
        cat CHANGELOG.md
        
    - name: Create Build Archive
      run: |
        # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞
        ARCHIVE_FILES="dist/ package.json README.md"
        
        # –î–æ–±–∞–≤–ª—è–µ–º audit.md –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if [ -f "docs/audit.md" ]; then
          ARCHIVE_FILES="$ARCHIVE_FILES docs/audit.md"
          echo "‚úÖ Including docs/audit.md in archive"
        else
          echo "‚ÑπÔ∏è docs/audit.md not found, skipping"
        fi
        
        # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ —Å–±–æ—Ä–∫–∏
        tar -czf n8n-node-converter-documents-${{ steps.version.outputs.version }}.tar.gz $ARCHIVE_FILES
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è
        if [ -f "n8n-node-converter-documents-${{ steps.version.outputs.version }}.tar.gz" ]; then
          ls -la *.tar.gz
          echo "‚úÖ Build archive created successfully"
        else
          echo "‚ùå Failed to create build archive"
          exit 1
        fi
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      id: create_release
      if: github.ref_type == 'tag'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: üöÄ Release ${{ steps.version.outputs.tag }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false
        generate_release_notes: true
        make_latest: true
        preserve_order: true
        files: |
          n8n-node-converter-documents-${{ steps.version.outputs.version }}.tar.gz
          package.json
        
    - name: Release Summary
      run: |
        echo "## üéâ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release URL:** ${{ steps.create_release.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release ID:** ${{ steps.create_release.outputs.id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Upload URL:** ${{ steps.create_release.outputs.upload_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Assets:** ${{ steps.create_release.outputs.assets }}" >> $GITHUB_STEP_SUMMARY

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–ª–∏–∑–µ
  notify:
    name: Post-Release Notification
    runs-on: ubuntu-latest
    needs: [test, release]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.release.result == 'success'
      run: |
        echo "üéâ Release completed successfully!"
        echo "‚úÖ Tests passed"
        echo "‚úÖ Release created"
        echo "‚úÖ Assets uploaded"
        
    - name: Notify Failure
      if: needs.release.result == 'failure' || needs.test.result == 'failure'
      run: |
        echo "‚ùå Release failed!"
        if [ "${{ needs.test.result }}" = "failure" ]; then
          echo "‚ùå Tests failed"
        fi
        if [ "${{ needs.release.result }}" = "failure" ]; then
          echo "‚ùå Release creation failed"
        fi
        exit 1 